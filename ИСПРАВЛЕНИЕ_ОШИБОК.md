# Исправление Ошибок CORS / Порты

## Проблема

При попытке использовать калькулятор Cockcroft-Gault на фронтенде возникали следующие ошибки:

```
Error: POST https://3001-4083002ef5af-web.clackypaas.com/api/v1/calculation_results - HTTP 500
Failed to execute 'json' on 'Response': Unexpected token '<', "<html>..." is not valid JSON
Unauthorized request from https://3000-4083002ef5af-web.clackypaas.com
```

## Причина

Несоответствие портов в конфигурации:
- **Фронтенд пытался подключиться к порту 3001** (через `config/api.ts`)
- **Backend API запущен на порту 8000** (через `api/main.py`)
- **Порт 3001 занят Metro Bundler** (Expo dev server)

Это привело к тому, что фронтенд отправлял запросы на Metro Bundler вместо Python API.

## Решение

### 1. Исправлена конфигурация портов

**Файл: `config/api.ts`**
- Изменен дефолтный порт с `3001` на `8000`
- Backend API теперь доступен по правильному адресу

**Файл: `app.config.js`**
- Обновлен `APP_PORT` дефолт с `3001` на `8000`

**Файл: `api/main.py`**
- Подтвержден порт `8000` для uvicorn

**Файл: `scripts/start-python-backend.sh`**
- Обновлен скрипт запуска для использования порта `8000`

### 2. Обновлена документация

**Файл: `.clackyrules`**
- Исправлена информация о портах:
  - Frontend (Expo web): 3000
  - Backend (Python API): 8000

## Архитектура Портов

```
┌─────────────────────────────────────┐
│  Браузер                            │
│  https://3000-xxx.clackypaas.com   │
└──────────────┬──────────────────────┘
               │
               v
┌─────────────────────────────────────┐
│  Web Proxy Server (Port 3000)      │
│  + Проксирует на Metro Bundler      │
└──────────────┬──────────────────────┘
               │
               v
┌─────────────────────────────────────┐
│  Metro Bundler (Port 3001)          │
│  + React Native / Expo              │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  Python FastAPI (Port 8000)         │
│  https://8000-xxx.clackypaas.com   │
│  + /api/v1/calculation_results      │
│  + /api/v1/health                   │
└─────────────────────────────────────┘
```

## Проверка

После исправления:

### Backend доступен:
```bash
curl https://8000-4083002ef5af-web.clackypaas.com/health
# {"status":"healthy"}

curl https://8000-4083002ef5af-web.clackypaas.com/api/v1/health
# {"status":"healthy"}
```

### Frontend работает:
```bash
curl https://3000-4083002ef5af-web.clackypaas.com
# Возвращает HTML приложения
```

### Все тесты проходят:
```bash
npm test
# 3 test suites, 8 tests - all passed ✅
```

## Калькулятор Cockcroft-Gault

Теперь калькулятор работает корректно:
1. Расчет выполняется на фронтенде (формула в `lib/calculators/cockcroftGault.ts`)
2. Результат сохраняется в историю через API на порту 8000
3. Интерпретация результатов на основе стадий ХБП

### Формула:
```typescript
ClCr = ((140 - age) * weight * sex_factor) / (72 * creatinine)
```

### Интерпретация (CKD стадии):
- ≥90 мл/мин: Норма (G1)
- 60-89: Легкое снижение (G2)
- 45-59: Умеренное снижение (G3a)
- 30-44: Средней тяжести (G3b)
- 15-29: Тяжелое снижение (G4)
- <15: Терминальная стадия (G5)

## Итог

✅ Порты настроены корректно  
✅ CORS работает  
✅ Backend доступен на порту 8000  
✅ Frontend доступен на порту 3000  
✅ Калькулятор работает на фронтенде  
✅ История результатов сохраняется в базу  
✅ Все тесты проходят
