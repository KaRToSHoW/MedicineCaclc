# Финальное Исправление Ошибок - Конфигурация Портов

## Проблема
Frontend продолжал отправлять запросы на неправильный порт (3001 вместо 8000).

## Корневая Причина
Переменная окружения `APP_PORT` не передавалась в `app.config.js` во время выполнения Expo.

## Решение

### 1. Добавлена переменная в .env
```env
# Frontend Configuration
# Backend API port (used by config/api.ts)
EXPO_PUBLIC_APP_PORT=8000
```

Expo автоматически читает переменные с префиксом `EXPO_PUBLIC_*` и делает их доступными в `Constants.expoConfig.extra`.

### 2. Настроен Python backend для игнорирования лишних переменных
Файл: `api/app/core/config.py`
```python
class Config:
    env_file = ".env"
    case_sensitive = True
    extra = "ignore"  # Ignore extra env vars like EXPO_PUBLIC_*
```

Это предотвращает ошибку Pydantic, когда backend видит `EXPO_PUBLIC_APP_PORT` в `.env`.

### 3. Добавлена отладочная информация
Файл: `config/api.ts`
```typescript
console.log('[API Config] Environment variables:', {
  APP_PORT: extra.APP_PORT,
  PUBLIC_HOST: extra.PUBLIC_HOST,
  CLACKY_PREVIEW_DOMAIN_BASE: extra.CLACKY_PREVIEW_DOMAIN_BASE
});
```

Это поможет диагностировать проблемы с конфигурацией в будущем.

### 4. Обновлены скрипты запуска
Файл: `scripts/start-expo.sh`
```bash
# Set backend API port for frontend config (if not already set)
export APP_PORT="${APP_PORT:-8000}"
```

Файл: `scripts/start-web-with-proxy.sh`
```bash
# Set backend API port for frontend config
export APP_PORT=8000
```

## Проверка

После этих изменений:

1. **Откройте https://3000-4083002ef5af-web.clackypaas.com**
2. **Откройте консоль разработчика (F12)**
3. **Нажмите "Рассчитать" на калькуляторе**
4. **Проверьте логи в консоли:**

Вы должны увидеть:
```
[API Config] Environment variables: { APP_PORT: "8000", CLACKY_PREVIEW_DOMAIN_BASE: "-4083002ef5af-web.clackypaas.com", ... }
[API Config] Using Cloud dev: https://8000-4083002ef5af-web.clackypaas.com { port: "8000", domainBase: "-4083002ef5af-web.clackypaas.com" }
```

## Следующий Шаг

Если после перезагрузки страницы (Ctrl+R или Cmd+R) всё ещё видите ошибку с портом 3001, очистите кэш браузера:
- Chrome/Edge: Ctrl+Shift+Delete → Очистить кэшированные изображения и файлы
- Firefox: Ctrl+Shift+Delete → Кэш
- Safari: Develop → Empty Caches

## Ожидаемый Результат

После исправления калькулятор Cockcroft-Gault должен:
1. Выполнить расчет на фронтенде
2. Отправить результат на `https://8000-4083002ef5af-web.clackypaas.com/api/v1/calculation_results`
3. Получить либо:
   - **401 Unauthorized** (если пользователь не залогинен) - это нормально
   - **201 Created** (если пользователь залогинен) - результат сохранён в историю

## Аутентификация

Если вы видите ошибку 401, это означает, что пользователь не залогинен. Вам нужно:
1. Зарегистрироваться или войти в систему
2. Только после этого калькулятор сможет сохранять результаты в историю

Расчет самого значения работает независимо от авторизации (выполняется на фронтенде).
